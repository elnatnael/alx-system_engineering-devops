#!/usr/bin/env bash
# Installs Nginx, sets up a Hello World page, and starts the service without systemctl

echo -e "Updating and installing nginx using sudo apt-get.\n"

# Update package list and install nginx
sudo apt-get update -y -qq && \
sudo apt-get install -y nginx

# Start nginx using service (not systemctl)
sudo service nginx start

# Allowing nginx on firewall
sudo ufw allow 'Nginx HTTP'

# Giving the user ownership to website files for easy editing
sudo chown -R "$USER":"$USER" /var/www/html
sudo chmod -R 755 /var/www

# Backup default index
cp /var/www/html/index.nginx-debian.html /var/www/html/index.nginx-debian.html.bckp

# Creating new custom index
echo "Hello World!" > /var/www/html/index.nginx-debian.html

# 404 page content (EXACTLY as required)
echo "Ceci n'est pas une page" > /var/www/html/custom_404.html

# Nginx config update for custom 404 page
CONFIG="/etc/nginx/sites-available/default"
if ! grep -q "error_page 404 /custom_404.html;" "$CONFIG"; then
  sudo sed -i '/location \/ {/a \\\terror_page 404 /custom_404.html;\n\tlocation = /custom_404.html {\n\t\troot /var/www/html;\n\t\tinternal;\n\t}' "$CONFIG"
fi

# Restarting nginx
sudo service nginx restart

echo -e "\nCompleted :))"
